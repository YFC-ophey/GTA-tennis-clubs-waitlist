{% extends "base.html" %}

{% block title %}Scraper - GTA Tennis Clubs Championship{% endblock %}

{% block content %}
<div class="card">
    <h2>üîç Championship Scraper</h2>

    <div id="alert-container"></div>

    <div style="margin-bottom: 30px;">
        <label for="max-clubs" style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--wimbledon-purple);">
            Number of clubs to scrape:
        </label>
        <input type="number" id="max-clubs" min="1" max="306" value="50"
               style="padding: 12px 16px; border: 2px solid rgba(62, 31, 71, 0.2); border-radius: 6px; width: 200px; font-size: 16px;">
        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
            üí° Start with 10-50 for testing. Enter 306 to scrape all clubs.
        </p>
    </div>

    <div style="margin-bottom: 30px;">
        <button id="start-btn" class="btn" onclick="startScraping()">
            Start Scraping
        </button>
        <button id="stop-btn" class="btn btn-danger" onclick="stopScraping()" style="display: none;">
            Stop
        </button>
    </div>

    <div id="progress-container" style="display: none;">
        <h3 style="margin-bottom: 20px; color: var(--wimbledon-purple);">‚è≥ Progress</h3>

        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%">
                0%
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 25px;">
            <div style="padding: 20px; background: var(--wimbledon-cream); border-radius: 8px; border-left: 4px solid var(--wimbledon-purple);">
                <strong style="color: var(--wimbledon-purple);">Current Club:</strong>
                <div id="current-club" style="color: #333; margin-top: 8px; font-weight: 600;">-</div>
            </div>
            <div style="padding: 20px; background: var(--wimbledon-cream); border-radius: 8px; border-left: 4px solid var(--wimbledon-purple);">
                <strong style="color: var(--wimbledon-purple);">Progress:</strong>
                <div id="progress-text" style="color: #333; margin-top: 8px; font-weight: 600;">0 / 0</div>
            </div>
            <div style="padding: 20px; background: var(--wimbledon-cream); border-radius: 8px; border-left: 4px solid var(--wimbledon-green);">
                <strong style="color: var(--wimbledon-green);">Successful:</strong>
                <div id="successful-count" style="color: #333; margin-top: 8px; font-weight: 600;">0</div>
            </div>
            <div style="padding: 20px; background: var(--wimbledon-cream); border-radius: 8px; border-left: 4px solid #c41e3a;">
                <strong style="color: #c41e3a;">Failed:</strong>
                <div id="failed-count" style="color: #333; margin-top: 8px; font-weight: 600;">0</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>‚ÑπÔ∏è Information</h2>

    <div style="background: var(--wimbledon-cream); padding: 25px; border-radius: 10px;">
        <h3 style="margin-bottom: 20px;">What gets scraped?</h3>
        <ul style="line-height: 2.2; color: #333; list-style-position: inside;">
            <li>‚úÖ <strong>Club Name</strong></li>
            <li>‚úÖ <strong>Location</strong> (City)</li>
            <li>‚úÖ <strong>Email Address</strong></li>
            <li>‚úÖ <strong>Club Type</strong> (Private/Public/Community)</li>
            <li>‚úÖ <strong>Membership Status</strong> (Open/Waitlist/Closed)</li>
            <li>‚úÖ <strong>Waitlist Length</strong></li>
            <li>‚úÖ <strong>Number of Courts</strong></li>
            <li>‚úÖ <strong>Court Surface</strong></li>
            <li>‚úÖ <strong>Operating Season</strong></li>
        </ul>

        <div style="margin-top: 25px; padding: 20px; background: white; border-left: 5px solid var(--wimbledon-green); border-radius: 4px;">
            <strong style="color: var(--wimbledon-green);">‚ö†Ô∏è Note:</strong> The scraper respects rate limits (0.5 seconds between requests).
            Scraping all 306 clubs takes approximately 15-20 minutes.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let statusInterval = null;

    function startScraping() {
        const maxClubs = $('#max-clubs').val();
        const data = maxClubs ? { max_clubs: parseInt(maxClubs) } : {};

        $('#start-btn').prop('disabled', true).html('<span class="loading"></span> Starting...');
        $('#alert-container').html('');

        $.ajax({
            url: '/api/start-scraping',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showAlert('üéæ Scraping started successfully!', 'success');
                $('#progress-container').show();
                $('#start-btn').hide();
                $('#stop-btn').show();

                // Start polling for status
                statusInterval = setInterval(updateStatus, 1000);
            },
            error: function(xhr) {
                showAlert('Error: ' + (xhr.responseJSON?.error || 'Failed to start scraping'), 'error');
                $('#start-btn').prop('disabled', false).text('Start Scraping');
            }
        });
    }

    function stopScraping() {
        if (confirm('Are you sure you want to stop scraping?')) {
            clearInterval(statusInterval);
            $('#start-btn').show().prop('disabled', false).text('Start Scraping');
            $('#stop-btn').hide();
            showAlert('Scraping stopped', 'info');
        }
    }

    function updateStatus() {
        $.get('/api/scraping-status', function(data) {
            if (!data.is_running) {
                clearInterval(statusInterval);
                $('#start-btn').show().prop('disabled', false).text('Start Scraping');
                $('#stop-btn').hide();
                showAlert('‚úÖ Scraping completed!', 'success');
                return;
            }

            const progress = data.progress || 0;
            $('#progress-fill').css('width', progress + '%').text(progress + '%');
            $('#current-club').text(data.current_name || '-');
            $('#progress-text').text(data.current_club + ' / ' + data.total_clubs);
            $('#successful-count').text(data.successful);
            $('#failed-count').text(data.failed);
        });
    }

    function showAlert(message, type) {
        const alertClass = 'alert-' + type;
        const html = '<div class="alert ' + alertClass + '">' + message + '</div>';
        $('#alert-container').html(html);

        // Auto-hide after 5 seconds
        setTimeout(function() {
            $('#alert-container').html('');
        }, 5000);
    }
</script>
{% endblock %}
