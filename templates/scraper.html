{% extends "base.html" %}

{% block title %}Web Scraper{% endblock %}

{% block extra_css %}
<style>
    .control-panel {
        background: white;
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 32px;
        border: 1px solid #E5E7EB;
    }

    .control-panel h3 {
        font-family: 'Playfair Display', Georgia, serif;
        color: #3D2273;
        font-size: 1.4em;
        margin: 0 0 24px 0;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--wimbledon-purple);
        font-weight: 600;
    }

    .form-group input {
        width: 100%;
        max-width: 300px;
    }

    .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    /* Progress Section */
    .progress-container {
        background: white;
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 32px;
        display: none;
        border: 1px solid #E5E7EB;
    }

    .progress-container h2 {
        font-family: 'Playfair Display', Georgia, serif;
        color: #3D2273;
        margin-bottom: 24px;
        font-size: 1.6em;
        font-weight: 600;
    }

    .progress-bar-container {
        background: #F3F4F6;
        border-radius: 12px;
        height: 32px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3D2273 0%, #2a1532 100%);
        width: 0%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.85em;
    }

    .progress-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 25px;
    }

    .stat-box {
        background: #F9FAFB;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #E5E7EB;
    }

    .stat-box .label {
        color: #6B7280;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .stat-box .value {
        font-family: 'Playfair Display', Georgia, serif;
        color: #1F1F1F;
        font-size: 2em;
        font-weight: 700;
    }

    .current-club {
        background: #F0FFF4;
        padding: 16px 20px;
        border-radius: 12px;
        margin-top: 24px;
        border: 1px solid #D1FAE5;
    }

    .current-club strong {
        color: #3D2273;
    }

    /* Alerts Container */
    #alerts-container {
        margin-bottom: 25px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header">
    <div>
        <h2>Web Scraper</h2>
        <p>Collect data from GTA tennis club websites</p>
    </div>
</header>

<!-- Alerts Container -->
<div id="alerts-container"></div>

<!-- Control Panel -->
<div class="control-panel">
    <h3>Scraper Controls</h3>

    <div class="form-group">
        <label for="max-clubs">
            Number of Clubs to Scrape (optional)
        </label>
        <input type="number" id="max-clubs" placeholder="Leave empty to scrape all clubs" min="1">
        <small style="color: #666; display: block; margin-top: 5px;">
            Tip: Start with 10-20 clubs for testing
        </small>
    </div>

    <div class="form-group">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="use-js-fallback" style="width: auto; cursor: pointer;">
            <span>üöÄ Enable JavaScript Fallback (Slower but handles React/Vue/Angular sites)</span>
        </label>
        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
            Uses headless browser for JavaScript-heavy websites. Requires Playwright installation.
        </small>
    </div>

    <div class="button-group">
        <button id="start-btn" class="btn" onclick="startScraping()">
            üéæ Start Scraping
        </button>
        <button id="stop-btn" class="btn btn-danger" onclick="stopScraping()" style="display: none;">
            ‚èπÔ∏è Stop Scraping
        </button>
    </div>
</div>

<!-- Progress Container -->
<div id="progress-container" class="progress-container">
    <h2>‚ö° Scraping Progress</h2>

    <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar">0%</div>
    </div>

    <div class="progress-stats">
        <div class="stat-box">
            <div class="label">Progress</div>
            <div class="value"><span id="progress-count">0</span> / <span id="total-count">0</span></div>
        </div>
        <div class="stat-box">
            <div class="label">Results Found</div>
            <div class="value" id="results-count">0</div>
        </div>
        <div class="stat-box">
            <div class="label">Errors</div>
            <div class="value" id="errors-count" style="color: #dc3545;">0</div>
        </div>
    </div>

    <div class="current-club">
        <strong>Currently scraping:</strong> <span id="current-club-name">-</span>
    </div>
</div>

<script>
let statusInterval = null;

// Start scraping - THIS IS THE CRITICAL FUNCTION THAT WAS MISSING
function startScraping() {
    const maxClubs = $('#max-clubs').val();
    const useJsFallback = $('#use-js-fallback').is(':checked');

    const data = {
        use_js_fallback: useJsFallback
    };
    if (maxClubs) {
        data.max_clubs = parseInt(maxClubs);
    }

    // Disable start button
    $('#start-btn').prop('disabled', true).html('<span class="loading"></span> Starting...');

    $.ajax({
        url: '/api/start-scraping',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            showAlert('üéæ Scraping started successfully!', 'success');
            $('#progress-container').show();
            $('#start-btn').hide();
            $('#stop-btn').show();

            // Start polling for status
            statusInterval = setInterval(updateStatus, 1000);
        },
        error: function(xhr) {
            showAlert('‚ùå Error starting scraper: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            $('#start-btn').prop('disabled', false).html('üéæ Start Scraping');
        }
    });
}

function stopScraping() {
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
    $('#start-btn').prop('disabled', false).html('üéæ Start Scraping').show();
    $('#stop-btn').hide();
    showAlert('‚èπÔ∏è Scraping stopped', 'warning');
}

function updateStatus() {
    $.get('/api/scraping-status', function(data) {
        if (!data.running && statusInterval) {
            // Scraping completed
            clearInterval(statusInterval);
            statusInterval = null;
            $('#start-btn').prop('disabled', false).html('üéæ Start Scraping').show();
            $('#stop-btn').hide();
            showAlert('‚úÖ Scraping completed! Visit the Results page to view data.', 'success');
        }

        // Update progress
        const percentage = data.total > 0 ? Math.round((data.progress / data.total) * 100) : 0;
        $('#progress-bar').css('width', percentage + '%').text(percentage + '%');

        // Update stats
        $('#progress-count').text(data.progress);
        $('#total-count').text(data.total);
        $('#results-count').text(data.results_count);
        $('#errors-count').text(data.errors_count);
        $('#current-club-name').text(data.current_club || '-');
    });
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type}" style="animation: slideIn 0.3s ease;">
            ${message}
        </div>
    `;
    $('#alerts-container').html(alertHtml);

    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('#alerts-container').fadeOut(function() {
            $(this).html('').show();
        });
    }, 5000);
}

// Check if scraping is already running on page load
$(document).ready(function() {
    $.get('/api/scraping-status', function(data) {
        if (data.running) {
            $('#progress-container').show();
            $('#start-btn').hide();
            $('#stop-btn').show();
            statusInterval = setInterval(updateStatus, 1000);
        }
    });
});
</script>

<style>
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
