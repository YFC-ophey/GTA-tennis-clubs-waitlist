{% extends "base.html" %}

{% block title %}Results{% endblock %}

{% block extra_css %}
<style>
    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-top: 4px solid #3D2273;
    }

    .stat-card h3 {
        color: #6B7280;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin: 0 0 8px 0;
    }

    .stat-card p {
        font-family: 'Playfair Display', Georgia, serif;
        font-size: 2.5em;
        color: #1F1F1F;
        margin: 0;
        font-weight: 700;
    }

    /* Search and Filter Bar */
    .filter-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 400px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 16px 10px 40px;
        border: 1px solid #D1D5DB;
        border-radius: 24px;
        font-size: 0.95em;
    }

    .search-box::before {
        content: 'üîç';
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1em;
    }

    /* Data Table Card */
    .data-table-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid #E5E7EB;
    }

    .table-header {
        padding: 20px 24px;
        border-bottom: 1px solid #E5E7EB;
        background: #F9FAFB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h3 {
        font-family: 'Playfair Display', Georgia, serif;
        font-size: 1.4em;
        color: #3D2273;
        font-weight: 600;
        margin: 0;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
    }

    .results-table thead {
        background: #3D2273;
        color: white;
    }

    .results-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    .results-table tbody tr {
        border-bottom: 1px solid #E5E7EB;
        transition: background-color 0.2s ease;
    }

    .results-table tbody tr:nth-child(even) {
        background: #F0FFF4;
    }

    .results-table tbody tr:hover {
        background: rgba(147, 51, 234, 0.05);
    }

    .results-table td {
        padding: 16px;
        font-size: 0.9em;
        color: #1F1F1F;
    }

    .results-table td:first-child {
        font-weight: 600;
    }

    .results-table td a {
        color: #00703C;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .results-table td a:hover {
        color: #005830;
        text-decoration: underline;
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
    }

    .status-verified {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-pending {
        background: #FEF3C7;
        color: #92400E;
    }

    .status-failed {
        background: #FEE2E2;
        color: #991B1B;
    }

    .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .no-results .icon {
        font-size: 4em;
        margin-bottom: 20px;
    }

    .no-results h3 {
        font-family: 'Playfair Display', Georgia, serif;
        color: #3D2273;
        font-size: 1.8em;
        margin-bottom: 10px;
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: 1fr;
        }

        .filter-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            max-width: none;
        }

        .results-table {
            font-size: 0.85em;
        }

        .results-table th,
        .results-table td {
            padding: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header">
    <div>
        <h2>Club Scraper</h2>
        <p>Manage data sources and extract club contact details</p>
    </div>
    <div class="page-header-actions">
        <button class="btn btn-outline" onclick="exportCSV()">
            <span>üì•</span> Export CSV
        </button>
        <button class="btn" onclick="loadResults()">
            <span>üîÑ</span> Refresh
        </button>
    </div>
</header>

<!-- Stats Row -->
<div class="stats-row">
    <div class="stat-card">
        <h3>Clubs Found</h3>
        <p id="summary-total">0</p>
    </div>
    <div class="stat-card">
        <h3>Emails Verified</h3>
        <p id="summary-emails">0%</p>
    </div>
    <div class="stat-card">
        <h3>Successful Scrapes</h3>
        <p id="summary-success">0</p>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Filter by region...">
    </div>
    <button class="btn btn-secondary" onclick="exportJSON()">
        <span>üì•</span> Export JSON
    </button>
</div>

<!-- Data Table Card -->
<div class="data-table-card">
    <div class="table-header">
        <h3>Recent Results</h3>
    </div>
    <table class="results-table">
        <thead>
            <tr>
                <th>Club Name</th>
                <th>Region</th>
                <th>Surface</th>
                <th>Email Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="results-body">
            <tr>
                <td colspan="5" class="no-results">
                    <div class="icon">üéæ</div>
                    <h3>No Results Yet</h3>
                    <p>Start scraping to see results here</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
let allResults = [];

function loadResults() {
    $.get('/api/results', function(data) {
        if (data.results && data.results.length > 0) {
            allResults = data.results;
            displayResults(allResults);
            updateSummary(allResults);
        } else {
            $('#results-body').html(`
                <tr>
                    <td colspan="5" class="no-results">
                        <div class="icon">üéæ</div>
                        <h3>No Results Yet</h3>
                        <p>Start scraping from the Scraper page to see results here</p>
                    </td>
                </tr>
            `);
            // Reset stats to 0
            $('#summary-total').text('0');
            $('#summary-emails').text('0%');
            $('#summary-success').text('0');
        }
    });
}

function displayResults(results) {
    if (!results || results.length === 0) {
        $('#results-body').html(`
            <tr>
                <td colspan="5" class="no-results">
                    <div class="icon">üîç</div>
                    <h3>No Matching Results</h3>
                    <p>Try a different search term</p>
                </td>
            </tr>
        `);
        return;
    }

    let html = '';
    results.forEach(function(club) {
        const status = club['Scrape Status'] || 'Unknown';
        const hasEmail = club.Email && club.Email !== 'N/A' && club.Email !== 'Contact form available';

        // Surface type badge color
        const surface = club['Court Surface'] || 'N/A';
        let surfaceClass = 'status-badge ';
        if (surface.toLowerCase().includes('grass')) surfaceClass += 'status-verified';
        else if (surface.toLowerCase().includes('clay')) surfaceClass += 'status-pending';
        else surfaceClass += 'status-failed';

        // Email status
        let emailStatus = '';
        if (hasEmail) {
            emailStatus = `<div class="status-badge status-verified"><div style="width:8px;height:8px;background:#065F46;border-radius:50%;"></div>${club.Email}</div>`;
        } else {
            emailStatus = `<div class="status-badge status-failed"><div style="width:8px;height:8px;background:#991B1B;border-radius:50%;"></div>N/A</div>`;
        }

        html += '<tr>';
        html += '<td><strong>' + (club['Club Name'] || 'N/A') + '</strong></td>';
        html += '<td>' + (club.Location || 'N/A') + '</td>';
        html += '<td><span class="' + surfaceClass + '">' + surface + '</span></td>';
        html += '<td>' + emailStatus + '</td>';
        html += '<td><a href="mailto:' + (club.Email || '') + '" style="color:#3D2273;">Draft Email ‚Üí</a></td>';
        html += '</tr>';
    });

    $('#results-body').html(html);
}

function updateSummary(results) {
    const total = results.length;
    const successfulScrapes = results.filter(r => r['Scrape Status'] &&
        (r['Scrape Status'] === 'Success' || r['Scrape Status'].includes('Pre-loaded'))).length;
    const emailsFound = results.filter(r => r.Email && r.Email !== 'N/A' && r.Email !== 'Contact form available').length;

    const emailPercentage = total > 0 ? Math.round((emailsFound / total) * 100) : 0;

    $('#summary-total').text(total.toLocaleString());
    $('#summary-emails').text(emailPercentage + '%');
    $('#summary-success').text(successfulScrapes);
}

function searchResults() {
    const searchTerm = $('#search-input').val().toLowerCase();

    if (!searchTerm) {
        displayResults(allResults);
        return;
    }

    const filtered = allResults.filter(function(club) {
        return (
            (club['Club Name'] || '').toLowerCase().includes(searchTerm) ||
            (club.Location || '').toLowerCase().includes(searchTerm) ||
            (club.Email || '').toLowerCase().includes(searchTerm)
        );
    });

    displayResults(filtered);
}

function exportCSV() {
    if (allResults.length === 0) {
        alert('No data to export. Please run the scraper first.');
        return;
    }

    // Create CSV content
    const headers = ['Club Name', 'Location', 'Email', 'Club Type', 'Membership Status',
                     'Waitlist Length', 'Number of Courts', 'Court Surface', 'Operating Season'];
    let csv = headers.join(',') + '\n';

    allResults.forEach(function(club) {
        const row = headers.map(function(header) {
            let value = club[header] || 'N/A';
            // Escape commas and quotes
            if (value.includes(',') || value.includes('"')) {
                value = '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
        });
        csv += row.join(',') + '\n';
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tennis_clubs_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}

function exportJSON() {
    if (allResults.length === 0) {
        alert('No data to export. Please run the scraper first.');
        return;
    }

    const json = JSON.stringify(allResults, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tennis_clubs_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
}

// Load results on page load
$(document).ready(function() {
    loadResults();

    // Search on input
    $('#search-input').on('input', searchResults);

    // Auto-refresh every 5 seconds
    setInterval(loadResults, 5000);
});
</script>
{% endblock %}
